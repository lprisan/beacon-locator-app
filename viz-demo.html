<!DOCTYPE html>
<html>
	<head>
		<title>Live LRS Demo</title>
		<link rel='stylesheet' href='assets/css/nv.d3.css'/>
		<script type="text/javascript" src="assets/js/d3.v3.js" charset="utf-8"></script>
		<script type="text/javascript" src="assets/js/nv.d3.js"></script>
		<script type="text/javascript" src="assets/js/xapiwrapper.min.js"></script>
		<script type="text/javascript" src="assets/js/chart.js"></script>
		<script type="text/javascript" src="assets/js/dashboard.js"></script>
		<script type="text/javascript" src="assets/js/xapicollection.js"></script>

		<style>
			h2 {
				text-align: center;
			}
			#graphContainer {
				display: flex;
				flex-direction: row;
				justify-content: center;
				align-items: center;
				flex-wrap: wrap;
			}

			.container {
				width: 500px;
				height: 300px;
				overflow: hidden;
			}

            path {
                stroke: steelblue;
                stroke-width: 2;
                fill: none;
            }

            .axis path,
            .axis line {
                fill: none;
                stroke: grey;
                stroke-width: 1;
                shape-rendering: crispEdges;
            }
		</style>

	</head>
	<body>
		<span id='status'>Fetching data</span>
		<!--div id='graphContainer'>
			<div id='verbs' class='container'>
				<svg></svg>
			</div>
			<div id='lrsActivity' class='container'>
				<svg></svg>
			</div>
			<div id='actorActivity' class='container'>
				<svg></svg>
			</div-->
            <div id='lrsMovement' class='container'>
				<svg></svg>
			</div>
		</div>
		<script>
            var N_SAMPLES = 100; //number of acc samples to show
			var wrapper = ADL.XAPIWrapper;
			wrapper.changeConfig({'endpoint': "https://htk.tlu.ee/lrs/data/xAPI/",
                'auth':  "Basic " + toBase64('4da0d771a634c608ff4c4730ba17fd8d9bc8ba8a:d753b5bf345d2c19e535f848cd350c0e9482f990')
            });

			var handle = setInterval(function(){
				document.querySelector('span').innerHTML += '.';
			}, 500);

            var search = ADL.XAPIWrapper.searchParams();
            search['verb'] = ADL.verbs.experienced.id;

            //TODO: call the getSTatements every second?


            // synchronous call
            //var res = ADL.XAPIWrapper.getStatements(search);
            //ADL.XAPIWrapper.log(res.statements);
            ADL.XAPIWrapper.getStatements(search, null,
               function getmore(r){
                  var res = JSON.parse(r.response);
                  //ADL.XAPIWrapper.log(res.statements);
                  console.log("Received "+res.statements.length+" from "+res.statements[0].stored+" to "+res.statements[res.statements.length-1].stored);
                  //We extract the samples to display
                  var samples = [];
                  for(var i=0; i<res.statements.length; i++){
                      var st = res.statements[i];
                      console.log("Processing statement "+st);
                      if(st.object.definition.extensions && st.object.definition.extensions["https://github.com/lprisan/classroom-tracker-app/"]){//If it's a classroom tracker statement
                          samples = samples.concat(st.object.definition.extensions["https://github.com/lprisan/classroom-tracker-app/"].accelData);
                      }
                  }
                  if(samples.length>=N_SAMPLES){
                        //sort from higher (newer) to lower
                        samples = samples.sort(function(a,b) {return (a.timestamp > b.timestamp) ? -1 : ((b.timestamp > a.timestamp) ? 1 : 0);} ).slice(0,N_SAMPLES);
                  }else{
                      if (res.more && res.more !== ""){
                         ADL.XAPIWrapper.getStatements(search, res.more, getmore);
                      }
                  }

                  console.log(JSON.stringify(samples));
                  drawGraph(samples);

               });

            // See http://bl.ocks.org/d3noob/b3ff6ae1c120eea654b5
            var drawGraph = function(data){

                var margin = {top: 30, right: 20, bottom: 30, left: 50},
                width = 600 - margin.left - margin.right,
                height = 270 - margin.top - margin.bottom;

                // Parse the date / time
                var parseDate = d3.time.format("%d-%b-%y %H:%M:%S.%L").parse;

                // Set the ranges
                var x = d3.time.scale().range([0, width]);
                var y = d3.scale.linear().range([height, 0]);

                // Define the axes
                var xAxis = d3.svg.axis().scale(x)
                    .orient("bottom").ticks(5);

                var yAxis = d3.svg.axis().scale(y)
                    .orient("left").ticks(5);

                // Define the line
                var valueline = d3.svg.line()
                    .x(function(d) { return x(new Date(d.timestamp)); })
                    .y(function(d) { return y(d.change); });

                // Adds the svg canvas
                var svg = d3.select("#lrsMovement")
                    .append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                        .attr("transform",
                              "translate(" + margin.left + "," + margin.top + ")");

                  data.forEach(function(d) {
                          d.timestamp = parseDate(new Date(d.timestamp));
                          d.change = +d.change;
                      });

                  // Scale the range of the data
                  x.domain(d3.extent(data, function(d) { return new Date(d.timestamp); }));
                  y.domain([0, d3.max(data, function(d) { return d.change; })]);

                  // Add the valueline path.
                  svg.append("path")
                      .attr("class", "line")
                      .attr("d", valueline(data));

                  // Add the X Axis
                  svg.append("g")
                      .attr("class", "x axis")
                      .attr("transform", "translate(0," + height + ")")
                      .call(xAxis);

                  // Add the Y Axis
                  svg.append("g")
                      .attr("class", "y axis")
                      .call(yAxis);


            }
		</script>
	</body>
</html>
