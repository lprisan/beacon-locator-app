<!DOCTYPE html>
<html>
	<head>
		<title>Live LRS Demo</title>
		<link rel='stylesheet' href='assets/css/nv.d3.css'/>
		<script type="text/javascript" src="assets/js/d3.v3.js" charset="utf-8"></script>
		<script type="text/javascript" src="assets/js/nv.d3.js"></script>
		<script type="text/javascript" src="assets/js/xapiwrapper.min.js"></script>
		<script type="text/javascript" src="assets/js/chart.js"></script>
		<script type="text/javascript" src="assets/js/dashboard.js"></script>
		<script type="text/javascript" src="assets/js/xapicollection.js"></script>

		<style>
			h2 {
				text-align: center;
			}
			#graphContainer {
				display: flex;
				flex-direction: row;
				justify-content: center;
				align-items: center;
				flex-wrap: wrap;
			}

			.container {
				width: 500px;
				height: 300px;
				overflow: hidden;
			}
		</style>

	</head>
	<body>
		<span id='status'>Fetching data</span>
		<!--div id='graphContainer'>
			<div id='verbs' class='container'>
				<svg></svg>
			</div>
			<div id='lrsActivity' class='container'>
				<svg></svg>
			</div>
			<div id='actorActivity' class='container'>
				<svg></svg>
			</div-->
            <div id='lrsMovement' class='container'>
				<svg></svg>
			</div>
		</div>
		<script>
            var N_SAMPLES = 100; //number of acc samples to show
			var wrapper = ADL.XAPIWrapper;
			wrapper.changeConfig({'endpoint': "https://htk.tlu.ee/lrs/data/xAPI/",
                'auth':  "Basic " + toBase64('4da0d771a634c608ff4c4730ba17fd8d9bc8ba8a:d753b5bf345d2c19e535f848cd350c0e9482f990')
            });

			var handle = setInterval(function(){
				document.querySelector('span').innerHTML += '.';
			}, 500);

            var search = ADL.XAPIWrapper.searchParams();
            search['verb'] = ADL.verbs.experienced.id;
            // synchronous call
            //var res = ADL.XAPIWrapper.getStatements(search);
            //ADL.XAPIWrapper.log(res.statements);
            ADL.XAPIWrapper.getStatements(search, null,
               function getmore(r){
                  var res = JSON.parse(r.response);
                  //ADL.XAPIWrapper.log(res.statements);
                  console.log("Received "+res.statements.length+" from "+res.statements[0].stored+" to "+res.statements[res.statements.length-1].stored);
                  //We extract the samples to display
                  var samples = [];
                  for(var i=0; i<res.statements.length; i++){
                      var st = res.statements[i];
                      console.log("Processing statement "+st);
                      if(st.object.definition.extensions && st.object.definition.extensions["https://github.com/lprisan/classroom-tracker-app/"]){//If it's a classroom tracker statement
                          samples.push(st.object.definition.extensions["https://github.com/lprisan/classroom-tracker-app/"].accelData);
                      }
                  }
                  if(samples.length>=N_SAMPLES){
                        samples.sort(function(a,b) {return (a.timestamp > b.timestamp) ? 1 : ((b.timestamp > a.timestamp) ? -1 : 0);} ); 
                  }else{
                      if (res.more && res.more !== ""){
                         ADL.XAPIWrapper.getStatements(search, res.more, getmore);
                      }
                  }

                  console.log(JSON.stringify(samples));
                  //TODO: draw the graph

               });


		</script>
	</body>
</html>
